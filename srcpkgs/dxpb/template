# Template file for 'dxpb'
pkgname=dxpb
version=0.0.21
revision=1
wrksrc=dxpb-master
build_wrksrc=src
build_style=gnu-makefile
hostmakedepends="pkg-config"
makedepends="zeromq-devel czmq-devel libxbps-devel sqlite-devel libsodium-devel
 libbsd-devel libgit2-devel graphviz-devel c-capnproto-devel"
make_install_target="install install-runit-scripts"
short_desc="Distributed XBPS Package Builder"
maintainer="Toyam Cox <Vaelatern@voidlinux.eu>"
license="ISC"
homepage="https://gitlab.com/dxpb/dxpb"
distfiles="https://gitlab.com/dxpb/dxpb/repository/${version}/archive.tar.gz>${pkgname}-${version}.tgz"
checksum=35e28163bd96a62e7ec3fd4613e334918d635900ff29dfa8b0b5b652a604e6fd

system_groups="_dxpb _dxpb_graph _dxpb_ssl"
system_accounts="_dxpb_import _dxpb_frontend _dxpb_filer _dxpb_build _dxpb_grapher _dxpb_watcher"

_dxpb_grapher_groups="_dxpb,_dxpb_import,_dxpb_filer,_dxpb_graph,_dxpb_ssl"
_dxpb_import_groups="_dxpb"
_dxpb_frontend_groups="_dxpb"
_dxpb_filer_groups="_dxpb"
_dxpb_build_groups="_dxpb"
_dxpb_build_homedir="/var/lib/dxpb/buildhome"

# Fix for being a gitlab upstream
create_wrksrc=yes
do_extract() {
	tar -x --no-same-permissions --no-same-owner --strip-components=1 -f $XBPS_SRCDISTDIR/${pkgname}-${version}/${pkgname}-${version}.tgz -C $wrksrc
}
# End Of Fix

post_install() {
	vlicense ../COPYING
	rm -rf ${DESTDIR}/var/run
	vmkdir etc/dxpb
	vinstall ../runsv/sv-common 0644 etc/dxpb
}

dxpb-main_package() {
	short_desc="${short_desc} - grapher core"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/bin/dxpb-graph-to-dot
		vmove usr/bin/dxpb-poke
		vmove usr/bin/dxpb-pkgimport-*
		vmove usr/bin/dxpb-grapher
		vmove etc/sv/dxpb-pkgimport-*
		vmove etc/sv/dxpb-grapher
	}
}

dxpb-repoman_package() {
	short_desc="${short_desc} - repository manager"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/bin/dxpb-hostdir-master
		vmove etc/sv/dxpb-hostdir-master
	}
}

dxpb-server_package() {
	short_desc="${short_desc} - publicly bindable server"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/bin/dxpb-frontend
		vmove etc/sv/dxpb-frontend
	}
}

dxpb-server-all_package() {
	short_desc="${short_desc} - metapkg for all server pkgs"
	build_style=meta
	depends="dxpb-server>=${version}_${revision}
		dxpb-repoman>=${version}_${revision}
		dxpb-main>=${version}_${revision}"
}

dxpb-remote_package() {
	short_desc="${short_desc} - Remote Daemons"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/bin/dxpb-builder
		vmove usr/bin/dxpb-hostdir-remote
		vmove etc/sv/dxpb-builder
		vmove etc/sv/dxpb-hostdir-remote
	}
}
